on:
  workflow_dispatch:
  workflow_call:
    secrets:
      RELEASE_AUTOMATION_BOT_PAT:
        required: true

name: Update GitHub Pages

env:
  release_branch: ysaito/dummy-branch

jobs:
  create-backport-pull-request:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.RELEASE_AUTOMATION_BOT_PAT }}

    - name: Prepare backport branch
      id: backport-branch
      run: |
        git fetch
        git checkout origin/main
        backport_branch="merge-${{ env.release_branch }}-to-main-$(date +%s)"
        git checkout -b "${backport_branch}"

        # this assumes the merge runs cleanly without conflicts
        git merge "origin/${{ env.release_branch }}" -m 'Merge remote-tracking branch "origin/${{ env.release_branch }}" into "merge-${{ env.release_branch }}-to-main"'
        git -c 'user.name=AWS SDK Rust Bot' -c 'user.email=aws-sdk-rust-primary@amazon.com' push origin HEAD

        echo "branch_name=${backport_branch}" > $GITHUB_OUTPUT

    - name: Create pull request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr create \
          --title "Dummy merge ${{ env.release_branch }} into main" \
          --body "Merge it with \`gh pr merge --admin --merge\` or manually merge it with the merge commit (not squash merge)." \
          --base main \
          --head ${{ steps.backport-branch.outputs.branch_name }} \
          --label "needs-sdk-review" \
          --author "AWS SDK Rust Bot <aws-sdk-rust-primary@amazon.com>" \
          --draft
