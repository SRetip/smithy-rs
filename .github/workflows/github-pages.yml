on:
  workflow_dispatch:
  workflow_call:
    secrets:
      RELEASE_AUTOMATION_BOT_PAT:
        required: true

name: Update GitHub Pages

env:
  release_branch: smithy-rs-release-1.x.y

jobs:
  create-backport-pull-request:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.RELEASE_AUTOMATION_BOT_PAT }}

    - name: Prepare backport branch
      id: backport-branch
      run: |
        git fetch
        git checkout origin/main
        backport_branch="merge-${{ env.release_branch }}-to-main-$(date +%s)"
        git checkout -b "${backport_branch}"

        # this assumes the merge runs cleanly without conflicts
        git merge "origin/${{ env.release_branch }}" -m 'Merge remote-tracking branch "origin/${{ env.release_branch }}" into "merge-${{ env.release_branch }}-to-main"'
        git -c 'user.name=AWS SDK Rust Bot' -c 'user.email=aws-sdk-rust-primary@amazon.com' push origin HEAD

        echo "branch_name=${backport_branch}" > $GITHUB_OUTPUT

    - name: Create pull request
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.RELEASE_AUTOMATION_BOT_PAT }}
        author: aws-sdk-rust-ci <aws-sdk-rust-primary@amazon.com>
        title: Dummy merge ${{ env.release_branch }} into main
        body: |
          Merge it with `gh pr merge --admin --merge` or manually merge it with the merge commit (not squash merge).

          _By submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice._
        branch: ${{ steps.backport-branch.outputs.branch_name }}
        base: main
        draft: true
        labels: |
          needs-sdk-review
